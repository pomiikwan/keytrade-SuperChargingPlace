<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>千站液冷超充项目 - 增强交互式情景预测</title>
    <link rel="stylesheet" href="库里蓝暗夜主题.css">
    <style>
        /* 增强交互式计算器特有样式 */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .feature-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(0, 119, 192, 0.3);
            flex-wrap: wrap;
        }

        .tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #B8C5D6;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            border-radius: 10px 10px 0 0;
        }

        .tab.active {
            color: #FFC72C;
            border-bottom-color: #FFC72C;
            background: rgba(255, 199, 44, 0.1);
        }

        .tab:hover {
            color: #FFFFFF;
            background: rgba(29, 66, 138, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .parameters-panel {
            background: rgba(26, 35, 71, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .visualization-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }

        .chart-container {
            background: rgba(26, 35, 71, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            position: relative;
            overflow: hidden;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #1D428A, #0077C0);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .risk-assessment {
            background: rgba(26, 35, 71, 0.9);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            margin-bottom: 30px;
        }

        .risk-factors {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .risk-factor {
            background: rgba(29, 66, 138, 0.3);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(0, 119, 192, 0.2);
            transition: all 0.3s ease;
        }

        .risk-factor:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 119, 192, 0.3);
            border-color: rgba(255, 199, 44, 0.4);
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .risk-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .risk-level {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .risk-low {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .risk-medium {
            background: rgba(255, 193, 7, 0.2);
            color: #FFC107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .risk-high {
            background: rgba(244, 67, 54, 0.2);
            color: #F44336;
            border: 1px solid rgba(244, 67, 54, 0.3);
        }

        .risk-slider {
            width: 100%;
            margin: 15px 0;
        }

        .risk-description {
            color: #B8C5D6;
            font-size: 14px;
            line-height: 1.5;
        }

        .scenario-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .scenario-btn {
            padding: 12px 20px;
            border: 2px solid rgba(0, 119, 192, 0.3);
            border-radius: 25px;
            background: rgba(26, 35, 71, 0.7);
            color: #B8C5D6;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .scenario-btn:hover {
            border-color: #FFC72C;
            color: #FFFFFF;
            background: rgba(29, 66, 138, 0.9);
            transform: translateY(-2px);
        }

        .scenario-btn.active {
            background: linear-gradient(135deg, #1D428A, #0077C0);
            border-color: #FFC72C;
            color: #FFFFFF;
            box-shadow: 0 4px 15px rgba(255, 199, 44, 0.3);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(26, 35, 71, 0.7);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(0, 119, 192, 0.3);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #1D428A, #0077C0, #FFC72C);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .result-card:hover::before {
            transform: scaleX(1);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 119, 192, 0.3);
            border-color: rgba(255, 199, 44, 0.4);
        }

        .result-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #FFC72C, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .result-label {
            font-size: 14px;
            color: #B8C5D6;
            font-weight: 500;
        }

        .result-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .trend-up {
            color: #4CAF50;
        }

        .trend-down {
            color: #F44336;
        }

        .param-group {
            margin-bottom: 25px;
        }

        .param-group-title {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.single {
            grid-template-columns: 1fr;
        }

        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #1D428A, #0077C0);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(0, 119, 192, 0.3);
        }

        .calculate-btn:hover {
            background: linear-gradient(135deg, #0077C0, #1D428A);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 119, 192, 0.4);
        }

        .export-btn {
            padding: 10px 20px;
            background: rgba(255, 199, 44, 0.1);
            border: 1px solid rgba(255, 199, 44, 0.3);
            color: #FFC72C;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .export-btn:hover {
            background: rgba(255, 199, 44, 0.2);
            border-color: #FFC72C;
            color: #FFFFFF;
        }

        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 20px;
            font-size: 12px;
            color: #4CAF50;
            margin-left: 15px;
        }

        .real-time-dot {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sensitivity-chart {
            height: 300px;
            position: relative;
            background: rgba(10, 14, 39, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .chart-svg {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 1200px) {
            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .parameters-panel {
                position: static;
            }

            .visualization-panel {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                padding: 15px;
            }

            .feature-tabs {
                gap: 10px;
            }

            .tab {
                padding: 12px 18px;
                font-size: 14px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .results-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .risk-factors {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- 头部区域 -->
        <div class="header-section fade-in">
            <div class="header">
                <h1 class="title">增强交互式情景预测</h1>
                <p class="subtitle">实时数据可视化 · 投资情景模拟 · 风险评估分析</p>
                <div class="real-time-indicator">
                    <div class="real-time-dot"></div>
                    <span>实时计算中</span>
                </div>
            </div>
        </div>

        <!-- 功能标签页 -->
        <div class="feature-tabs">
            <button class="tab active" onclick="switchTab('calculator')">
                🧮 财务计算器
            </button>
            <button class="tab" onclick="switchTab('scenarios')">
                📊 投资情景
            </button>
            <button class="tab" onclick="switchTab('risk')">
                ⚠️ 风险评估
            </button>
            <button class="tab" onclick="switchTab('visualization')">
                📈 数据可视化
            </button>
        </div>

        <!-- 财务计算器标签页 -->
        <div id="calculator" class="tab-content active">
            <div class="calculator-grid">
                <!-- 参数面板 -->
                <div class="parameters-panel">
                    <div class="param-group">
                        <div class="param-group-title">
                            <span>🏗️</span>
                            <span>基础设施参数</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>总投资额（亿元）</label>
                                <input type="number" id="totalInvestment" value="28" min="1" max="100" step="1">
                            </div>
                            <div class="form-group">
                                <label>建设站点数</label>
                                <input type="number" id="stationCount" value="1000" min="100" max="5000" step="100">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>单站功率（kW）</label>
                                <input type="number" id="stationPower" value="7200" min="1000" max="10000" step="100">
                            </div>
                            <div class="form-group">
                                <label>建设周期（年）</label>
                                <input type="number" id="constructionPeriod" value="4" min="1" max="10" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="param-group">
                        <div class="param-group-title">
                            <span>💰</span>
                            <span>财务参数</span>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>年充电量利用率</label>
                                <input type="number" id="utilizationRate" value="25" min="5" max="50" step="1">
                            </div>
                            <div class="form-group">
                                <label>充电服务费（元/kWh）</label>
                                <input type="number" id="serviceFee" value="0.8" min="0.1" max="2" step="0.1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>运维成本率</label>
                                <input type="number" id="maintenanceCost" value="15" min="5" max="30" step="1">
                            </div>
                            <div class="form-group">
                                <label>折现率</label>
                                <input type="number" id="discountRate" value="12" min="5" max="20" step="1">
                            </div>
                        </div>
                    </div>

                    <button class="calculate-btn" onclick="calculateResults()">
                        开始计算
                    </button>
                </div>

                <!-- 可视化面板 -->
                <div class="visualization-panel">
                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon">📈</div>
                            <span>现金流预测</span>
                        </div>
                        <div id="cashflowChart" class="chart-placeholder">
                            <!-- 现金流图表将在这里渲染 -->
                        </div>
                    </div>

                    <div class="chart-container">
                        <div class="chart-title">
                            <div class="chart-icon">🎯</div>
                            <span>IRR敏感性分析</span>
                        </div>
                        <div id="irrChart" class="chart-placeholder">
                            <!-- IRR敏感性图表将在这里渲染 -->
                        </div>
                    </div>

                    <div class="chart-container full-width">
                        <div class="chart-title">
                            <div class="chart-icon">💹</div>
                            <span>投资回报分析</span>
                            <button class="export-btn" onclick="exportChart()">导出图表</button>
                        </div>
                        <div id="roiChart" class="chart-placeholder">
                            <!-- ROI分析图表将在这里渲染 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 计算结果 -->
            <div class="results-grid" id="resultsGrid">
                <div class="result-card">
                    <div class="result-value" id="irrValue">42.8%</div>
                    <div class="result-label">内部收益率 (IRR)</div>
                    <div class="result-trend trend-up">↑ 优于行业平均</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="npvValue">12.4亿</div>
                    <div class="result-label">净现值 (NPV@12%)</div>
                    <div class="result-trend trend-up">↑ 投资价值高</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="paybackValue">4.5年</div>
                    <div class="result-label">投资回收期</div>
                    <div class="result-trend trend-up">↑ 回收速度快</div>
                </div>
                <div class="result-card">
                    <div class="result-value" id="profitValue">121.9亿</div>
                    <div class="result-label">10年累计利润</div>
                    <div class="result-trend trend-up">↑ 盈利能力强</div>
                </div>
            </div>
        </div>

        <!-- 投资情景标签页 -->
        <div id="scenarios" class="tab-content">
            <div class="scenario-buttons">
                <button class="scenario-btn" onclick="loadScenario('conservative')">悲观情景</button>
                <button class="scenario-btn active" onclick="loadScenario('baseline')">基准情景</button>
                <button class="scenario-btn" onclick="loadScenario('optimistic')">乐观情景</button>
                <button class="scenario-btn" onclick="loadScenario('custom')">自定义情景</button>
            </div>

            <div class="visualization-panel">
                <div class="chart-container full-width">
                    <div class="chart-title">
                        <div class="chart-icon">📊</div>
                        <span>多情景对比分析</span>
                    </div>
                    <div id="scenarioChart" class="chart-placeholder">
                        <!-- 情景对比图表 -->
                    </div>
                </div>
            </div>

            <div class="results-grid" id="scenarioResults">
                <!-- 情景分析结果 -->
            </div>
        </div>

        <!-- 风险评估标签页 -->
        <div id="risk" class="tab-content">
            <div class="risk-assessment">
                <div class="chart-title">
                    <div class="chart-icon">⚠️</div>
                    <span>风险评估矩阵</span>
                    <button class="export-btn" onclick="exportRiskReport()">导出风险报告</button>
                </div>

                <div class="risk-factors">
                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🏗️ 技术风险</div>
                            <div class="risk-level risk-medium">中等</div>
                        </div>
                        <input type="range" class="risk-slider" id="techRisk" min="0" max="100" value="35">
                        <div class="risk-description">
                            液冷超充技术成熟度、设备可靠性、技术迭代风险
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">📈 市场风险</div>
                            <div class="risk-level risk-low">较低</div>
                        </div>
                        <input type="range" class="risk-slider" id="marketRisk" min="0" max="100" value="25">
                        <div class="risk-description">
                            市场竞争激烈度、需求增长预期、价格波动风险
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🏛️ 政策风险</div>
                            <div class="risk-level risk-medium">中等</div>
                        </div>
                        <input type="range" class="risk-slider" id="policyRisk" min="0" max="100" value="40">
                        <div class="risk-description">
                            补贴政策变化、行业标准更新、监管要求调整
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">💰 财务风险</div>
                            <div class="risk-level risk-low">较低</div>
                        </div>
                        <input type="range" class="risk-slider" id="financialRisk" min="0" max="100" value="20">
                        <div class="risk-description">
                            融资成本变化、现金流稳定性、汇率波动风险
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">⚡ 运营风险</div>
                            <div class="risk-level risk-medium">中等</div>
                        </div>
                        <input type="range" class="risk-slider" id="operationalRisk" min="0" max="100" value="30">
                        <div class="risk-description">
                            运维管理复杂性、人员技能要求、设备维护成本
                        </div>
                    </div>

                    <div class="risk-factor">
                        <div class="risk-header">
                            <div class="risk-name">🌍 环境风险</div>
                            <div class="risk-level risk-low">较低</div>
                        </div>
                        <input type="range" class="risk-slider" id="environmentalRisk" min="0" max="100" value="15">
                        <div class="risk-description">
                            环保要求变化、能源政策调整、可持续发展压力
                        </div>
                    </div>
                </div>

                <div class="sensitivity-chart">
                    <h4 style="color: #FFFFFF; margin-bottom: 15px;">敏感性分析 - 蜘蛛图</h4>
                    <svg id="riskSpiderChart" class="chart-svg">
                        <!-- 蜘蛛图将在这里渲染 -->
                    </svg>
                </div>
            </div>
        </div>

        <!-- 数据可视化标签页 -->
        <div id="visualization" class="tab-content">
            <div class="visualization-panel">
                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon">🌍</div>
                        <span>市场趋势分析</span>
                    </div>
                    <div id="marketTrendChart" class="chart-placeholder">
                        <!-- 市场趋势图表 -->
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">
                        <div class="chart-icon">🚗</div>
                        <span>电动车增长预测</span>
                    </div>
                    <div id="evGrowthChart" class="chart-placeholder">
                        <!-- 电动车增长图表 -->
                    </div>
                </div>

                <div class="chart-container full-width">
                    <div class="chart-title">
                        <div class="chart-icon">💡</div>
                        <span>技术演进路线图</span>
                    </div>
                    <div id="techRoadmapChart" class="chart-placeholder">
                        <!-- 技术路线图 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentScenario = 'baseline';
        let calculationResults = {};

        // 标签页切换
        function switchTab(tabName) {
            // 移除所有活动状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // 激活选中的标签页
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // 根据标签页初始化相应功能
            switch(tabName) {
                case 'calculator':
                    initCalculator();
                    break;
                case 'scenarios':
                    initScenarios();
                    break;
                case 'risk':
                    initRiskAssessment();
                    break;
                case 'visualization':
                    initVisualization();
                    break;
            }
        }

        // 财务计算功能
        function calculateResults() {
            const params = {
                totalInvestment: parseFloat(document.getElementById('totalInvestment').value),
                stationCount: parseInt(document.getElementById('stationCount').value),
                stationPower: parseInt(document.getElementById('stationPower').value),
                constructionPeriod: parseInt(document.getElementById('constructionPeriod').value),
                utilizationRate: parseFloat(document.getElementById('utilizationRate').value),
                serviceFee: parseFloat(document.getElementById('serviceFee').value),
                maintenanceCost: parseFloat(document.getElementById('maintenanceCost').value),
                discountRate: parseFloat(document.getElementById('discountRate').value)
            };

            // 计算核心财务指标
            const annualRevenue = params.stationCount * params.stationPower * params.utilizationRate / 100 * 365 * params.serviceFee / 1000;
            const annualCost = annualRevenue * params.maintenanceCost / 100;
            const annualProfit = annualRevenue - annualCost;

            // 10年现金流分析
            let cashFlows = [];
            let cumulativeCashFlow = -params.totalInvestment * 10000; // 转换为万元

            for (let year = 1; year <= 10; year++) {
                if (year <= params.constructionPeriod) {
                    // 建设期，逐步投资
                    const investment = -params.totalInvestment * 10000 / params.constructionPeriod;
                    cumulativeCashFlow += investment;
                    cashFlows.push({
                        year: year,
                        investment: investment,
                        revenue: 0,
                        profit: investment,
                        cumulative: cumulativeCashFlow
                    });
                } else {
                    // 运营期
                    cumulativeCashFlow += annualProfit;
                    cashFlows.push({
                        year: year,
                        investment: 0,
                        revenue: annualRevenue,
                        profit: annualProfit,
                        cumulative: cumulativeCashFlow
                    });
                }
            }

            // 计算IRR
            const irr = calculateIRR(cashFlows.map(cf => cf.profit), params.totalInvestment * 10000);

            // 计算NPV
            const npv = calculateNPV(cashFlows.map(cf => cf.profit), params.discountRate / 100);

            // 计算投资回收期
            let paybackPeriod = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                if (cashFlows[i].cumulative > 0) {
                    paybackPeriod = i;
                    break;
                }
            }

            // 10年总利润
            const totalProfit = cashFlows.reduce((sum, cf) => sum + Math.max(0, cf.profit), 0);

            // 更新结果显示
            document.getElementById('irrValue').textContent = irr.toFixed(1) + '%';
            document.getElementById('npvValue').textContent = (npv / 10000).toFixed(1) + '亿';
            document.getElementById('paybackValue').textContent = paybackPeriod + '年';
            document.getElementById('profitValue').textContent = (totalProfit / 10000).toFixed(1) + '亿';

            // 保存结果
            calculationResults = {
                irr: irr,
                npv: npv,
                paybackPeriod: paybackPeriod,
                totalProfit: totalProfit,
                cashFlows: cashFlows,
                params: params
            };

            // 更新图表
            updateCharts();
        }

        // IRR计算函数
        function calculateIRR(cashFlows, initialInvestment) {
            let irr = 0.1; // 初始猜测值
            let npv;
            const maxIterations = 100;
            const tolerance = 0.0001;

            for (let i = 0; i < maxIterations; i++) {
                npv = -initialInvestment;
                for (let j = 0; j < cashFlows.length; j++) {
                    npv += cashFlows[j] / Math.pow(1 + irr, j + 1);
                }

                if (Math.abs(npv) < tolerance) {
                    break;
                }

                // 牛顿-拉夫逊法
                let derivative = 0;
                for (let j = 0; j < cashFlows.length; j++) {
                    derivative -= (j + 1) * cashFlows[j] / Math.pow(1 + irr, j + 2);
                }

                irr = irr - npv / derivative;

                if (irr < -0.99) irr = -0.99; // 防止分母为零
            }

            return irr * 100; // 转换为百分比
        }

        // NPV计算函数
        function calculateNPV(cashFlows, discountRate) {
            let npv = 0;
            for (let i = 0; i < cashFlows.length; i++) {
                npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
            }
            return npv;
        }

        // 更新图表
        function updateCharts() {
            drawCashflowChart();
            drawIRRChart();
            drawROIChart();
        }

        // 绘制现金流图表
        function drawCashflowChart() {
            const container = document.getElementById('cashflowChart');
            if (!calculationResults.cashFlows) return;

            const data = calculationResults.cashFlows;
            const width = container.offsetWidth;
            const height = 250;
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // 创建SVG
            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(${margin.left},${margin.top})">
                        <!-- 坐标轴 -->
                        <line x1="0" y1="${chartHeight}" x2="${chartWidth}" y2="${chartHeight}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${chartHeight}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- 现金流柱状图 -->
                        ${data.map((d, i) => {
                            const barWidth = chartWidth / data.length * 0.6;
                            const x = i * (chartWidth / data.length) + (chartWidth / data.length - barWidth) / 2;
                            const height = Math.abs(d.cumulative) / Math.max(...data.map(d => Math.abs(d.cumulative))) * chartHeight * 0.8;
                            const y = d.cumulative >= 0 ? chartHeight - height : chartHeight;

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${height}"
                                      fill="${d.cumulative >= 0 ? '#4CAF50' : '#F44336'}" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${chartHeight + 20}"
                                      text-anchor="middle" fill="#B8C5D6" font-size="12">第${d.year}年</text>
                            `;
                        }).join('')}

                        <!-- 标题 -->
                        <text x="${chartWidth/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="14">
                            累计现金流 (万元)
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // 绘制IRR敏感性图表
        function drawIRRChart() {
            const container = document.getElementById('irrChart');
            const width = container.offsetWidth;
            const height = 250;

            // 模拟敏感性数据
            const scenarios = [
                { name: '利用率-20%', irr: 32.1 },
                { name: '基准', irr: 42.8 },
                { name: '利用率+20%', irr: 53.4 },
                { name: '服务费-20%', irr: 35.2 },
                { name: '服务费+20%', irr: 50.3 },
                { name: '成本-20%', irr: 48.9 },
                { name: '成本+20%', irr: 36.7 }
            ];

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(40,20)">
                        <!-- 坐标轴 -->
                        <line x1="0" y1="${height-40}" x2="${width-60}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- 柱状图 -->
                        ${scenarios.map((s, i) => {
                            const barWidth = (width-100) / scenarios.length * 0.6;
                            const x = i * ((width-100) / scenarios.length) + 20;
                            const barHeight = (s.irr / 60) * (height-60);
                            const y = height-40-barHeight;

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}"
                                      fill="${s.name === '基准' ? '#FFC72C' : '#0077C0'}" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${y-5}" text-anchor="middle"
                                      fill="#FFFFFF" font-size="11">${s.irr}%</text>
                                <text x="${x + barWidth/2}" y="${height-25}" text-anchor="middle"
                                      fill="#B8C5D6" font-size="10" transform="rotate(-45 ${x + barWidth/2} ${height-25})">${s.name}</text>
                            `;
                        }).join('')}

                        <!-- 标题 -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="14">
                            IRR敏感性分析 (%)
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // 绘制ROI分析图表
        function drawROIChart() {
            const container = document.getElementById('roiChart');
            const width = container.offsetWidth;
            const height = 300;

            // 模拟ROI数据
            const years = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
            const roiData = years.map(year => ({
                year: year,
                investment: year <= 4 ? -7 : 0,
                return: year > 4 ? 12.19 : 0,
                cumulativeROI: year > 4 ? ((year-4) * 12.19 - 28) / 28 * 100 : -100 + (year * 25)
            }));

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(60,20)">
                        <!-- 坐标轴 -->
                        <line x1="0" y1="${height-40}" x2="${width-80}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- 零线 -->
                        <line x1="0" y1="${height-80}" x2="${width-80}" y2="${height-80}"
                              stroke="#FFC72C" stroke-width="1" stroke-dasharray="5,5"/>

                        <!-- ROI折线图 -->
                        <polyline points="${roiData.map(d =>
                            `${(d.year-1) * (width-100) / 9},${height-80-d.cumulativeROI * 1.5}`
                        ).join(' ')}"
                                  fill="none" stroke="#FFC72C" stroke-width="3"/>

                        <!-- 数据点 -->
                        ${roiData.map(d => `
                            <circle cx="${(d.year-1) * (width-100) / 9}"
                                    cy="${height-80-d.cumulativeROI * 1.5}" r="5" fill="#FFC72C"/>
                            <text x="${(d.year-1) * (width-100) / 9}" y="${height-25}"
                                  text-anchor="middle" fill="#B8C5D6" font-size="12">第${d.year}年</text>
                        `).join('')}

                        <!-- 标题 -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="16">
                            投资回报率 (ROI) 趋势
                        </text>

                        <!-- Y轴标签 -->
                        <text x="-10" y="5" text-anchor="end" fill="#B8C5D6" font-size="12">100%</text>
                        <text x="-10" y="${height-80}" text-anchor="end" fill="#B8C5D6" font-size="12">0%</text>
                        <text x="-10" y="${height-40}" text-anchor="end" fill="#B8C5D6" font-size="12">-100%</text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // 加载投资情景
        function loadScenario(scenario) {
            currentScenario = scenario;

            // 更新按钮状态
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 根据情景调整参数
            const scenarios = {
                conservative: {
                    utilizationRate: 20,
                    serviceFee: 0.6,
                    maintenanceCost: 18,
                    totalInvestment: 32
                },
                baseline: {
                    utilizationRate: 25,
                    serviceFee: 0.8,
                    maintenanceCost: 15,
                    totalInvestment: 28
                },
                optimistic: {
                    utilizationRate: 35,
                    serviceFee: 1.0,
                    maintenanceCost: 12,
                    totalInvestment: 25
                },
                custom: {
                    // 保持当前参数
                }
            };

            const params = scenarios[scenario];
            if (params && scenario !== 'custom') {
                document.getElementById('utilizationRate').value = params.utilizationRate;
                document.getElementById('serviceFee').value = params.serviceFee;
                document.getElementById('maintenanceCost').value = params.maintenanceCost;
                document.getElementById('totalInvestment').value = params.totalInvestment;
            }

            // 重新计算
            calculateResults();
        }

        // 初始化计算器
        function initCalculator() {
            calculateResults();
        }

        // 初始化情景分析
        function initScenarios() {
            drawScenarioChart();
        }

        // 绘制情景对比图表
        function drawScenarioChart() {
            const container = document.getElementById('scenarioChart');
            const width = container.offsetWidth;
            const height = 300;

            const scenarios = [
                { name: '悲观情景', irr: 32.1, npv: 8.2, payback: 5.8 },
                { name: '基准情景', irr: 42.8, npv: 12.4, payback: 4.5 },
                { name: '乐观情景', irr: 58.3, npv: 21.8, payback: 3.2 }
            ];

            const svg = `
                <svg width="${width}" height="${height}">
                    <g transform="translate(60,20)">
                        <!-- 坐标轴 -->
                        <line x1="0" y1="${height-40}" x2="${width-80}" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>
                        <line x1="0" y1="0" x2="0" y2="${height-40}" stroke="#B8C5D6" stroke-width="2"/>

                        <!-- IRR柱状图 -->
                        ${scenarios.map((s, i) => {
                            const barWidth = 80;
                            const x = i * 120;
                            const height = (s.irr / 70) * (height-60);
                            const y = height-40-height;

                            return `
                                <rect x="${x}" y="${y}" width="${barWidth}" height="${height}"
                                      fill="#0077C0" opacity="0.8"/>
                                <text x="${x + barWidth/2}" y="${y-5}" text-anchor="middle"
                                      fill="#FFFFFF" font-size="14">${s.irr}%</text>
                                <text x="${x + barWidth/2}" y="${height-25}" text-anchor="middle"
                                      fill="#B8C5D6" font-size="12">${s.name}</text>
                                <text x="${x + barWidth/2}" y="${height-10}" text-anchor="middle"
                                      fill="#FFC72C" font-size="11">回收期${s.payback}年</text>
                            `;
                        }).join('')}

                        <!-- 标题 -->
                        <text x="${(width-100)/2}" y="-5" text-anchor="middle" fill="#FFFFFF" font-size="16">
                            投资情景对比分析
                        </text>
                    </g>
                </svg>
            `;

            container.innerHTML = svg;
        }

        // 初始化风险评估
        function initRiskAssessment() {
            drawRiskSpiderChart();
        }

        // 绘制风险评估蜘蛛图
        function drawRiskSpiderChart() {
            const svg = document.getElementById('riskSpiderChart');
            const width = svg.clientWidth;
            const height = 250;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) / 2 - 40;

            const risks = [
                { name: '技术风险', value: 35 },
                { name: '市场风险', value: 25 },
                { name: '政策风险', value: 40 },
                { name: '财务风险', value: 20 },
                { name: '运营风险', value: 30 },
                { name: '环境风险', value: 15 }
            ];

            const angleStep = (Math.PI * 2) / risks.length;

            let paths = [];
            let labels = [];

            risks.forEach((risk, i) => {
                const angle = i * angleStep - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;

                // 网格线
                paths.push(`<line x1="${centerX}" y1="${centerY}" x2="${x}" y2="${y}"
                                stroke="#B8C5D6" stroke-width="1" opacity="0.3"/>`);

                // 风险值点
                const value = risk.value / 100;
                const vx = centerX + Math.cos(angle) * radius * value;
                const vy = centerY + Math.sin(angle) * radius * value;

                labels.push(`
                    <text x="${x + 20 * Math.cos(angle)}" y="${y + 20 * Math.sin(angle)}"
                          text-anchor="middle" fill="#B8C5D6" font-size="12">${risk.name}</text>
                    <circle cx="${vx}" cy="${vy}" r="4" fill="#FFC72C"/>
                `);
            });

            svg.innerHTML = `
                ${paths.join('')}
                <!-- 风险区域 -->
                <polygon points="${risks.map((risk, i) => {
                    const angle = i * angleStep - Math.PI / 2;
                    const value = risk.value / 100;
                    const x = centerX + Math.cos(angle) * radius * value;
                    const y = centerY + Math.sin(angle) * radius * value;
                    return `${x},${y}`;
                }).join(' ')}" fill="#0077C0" opacity="0.3" stroke="#0077C0" stroke-width="2"/>
                ${labels.join('')}
            `;
        }

        // 初始化数据可视化
        function initVisualization() {
            drawMarketTrendChart();
            drawEVGrowthChart();
            drawTechRoadmapChart();
        }

        // 绘制市场趋势图表
        function drawMarketTrendChart() {
            const container = document.getElementById('marketTrendChart');
            // 模拟市场趋势数据可视化
            container.innerHTML = `
                <div style="color: #B8C5D6; text-align: center; padding: 40px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">充电桩市场增长趋势</h4>
                    <p>2023年：300亿元 → 2028年：1250亿元</p>
                    <p style="color: #FFC72C; font-size: 24px; font-weight: bold; margin: 20px 0;">年复合增长率 35%</p>
                    <div style="display: flex; justify-content: space-around; margin-top: 30px;">
                        <div>
                            <div style="color: #4CAF50; font-size: 18px;">📈</div>
                            <div>政策驱动</div>
                        </div>
                        <div>
                            <div style="color: #0077C0; font-size: 18px;">🚗</div>
                            <div>电动车普及</div>
                        </div>
                        <div>
                            <div style="color: #FFC72C; font-size: 18px;">⚡</div>
                            <div>技术升级</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 绘制电动车增长图表
        function drawEVGrowthChart() {
            const container = document.getElementById('evGrowthChart');
            container.innerHTML = `
                <div style="color: #B8C5D6; text-align: center; padding: 40px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">电动车保有量预测</h4>
                    <div style="display: flex; justify-content: space-around; align-items: center; height: 150px;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #B8C5D6;">2023年</div>
                            <div style="font-size: 18px; color: #4CAF50; margin: 10px 0;">950万辆</div>
                            <div>渗透率 35%</div>
                        </div>
                        <div style="font-size: 30px; color: #FFC72C;">→</div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold; color: #FFFFFF;">2028年</div>
                            <div style="font-size: 18px; color: #0077C0; margin: 10px 0;">7000万辆</div>
                            <div>渗透率 60%</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(29, 66, 138, 0.3); border-radius: 10px;">
                        <div style="color: #FFC72C;">💡 充电需求将同步增长7.4倍</div>
                    </div>
                </div>
            `;
        }

        // 绘制技术路线图
        function drawTechRoadmapChart() {
            const container = document.getElementById('techRoadmapChart');
            container.innerHTML = `
                <div style="color: #B8C5D6; padding: 20px;">
                    <h4 style="color: #FFFFFF; margin-bottom: 20px;">液冷超充技术演进路线</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #4CAF50;">当前</div>
                                <div style="margin: 10px 0;">600kW</div>
                                <div style="font-size: 12px;">液冷超充</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; color: #B8C5D6; margin: 0 20px;">→</div>
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(0, 119, 192, 0.2); border: 1px solid #0077C0; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #0077C0;">2025年</div>
                                <div style="margin: 10px 0;">800kW</div>
                                <div style="font-size: 12px;">下一代超充</div>
                            </div>
                        </div>
                        <div style="font-size: 24px; color: #B8C5D6; margin: 0 20px;">→</div>
                        <div style="text-align: center; flex: 1;">
                            <div style="background: rgba(255, 199, 44, 0.2); border: 1px solid #FFC72C; border-radius: 10px; padding: 15px;">
                                <div style="font-size: 16px; font-weight: bold; color: #FFC72C;">2028年</div>
                                <div style="margin: 10px 0;">1000kW</div>
                                <div style="font-size: 12px;">兆瓦级充电</div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 15px; background: rgba(29, 66, 138, 0.3); border-radius: 10px; text-align: center;">
                        <div style="color: #FFC72C;">🚀 技术持续迭代，保持行业领先地位</div>
                    </div>
                </div>
            `;
        }

        // 导出功能
        function exportChart() {
            alert('图表导出功能：支持PNG、PDF、Excel格式导出');
        }

        function exportRiskReport() {
            alert('风险评估报告导出：包含完整风险分析和应对建议');
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initCalculator();

            // 监听参数变化，实时更新计算
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (document.getElementById('calculator').classList.contains('active')) {
                        calculateResults();
                    }
                });
            });

            // 监听风险滑块变化
            const riskSliders = document.querySelectorAll('.risk-slider');
            riskSliders.forEach(slider => {
                slider.addEventListener('input', function() {
                    updateRiskLevel(this);
                    drawRiskSpiderChart();
                });
            });
        });

        // 更新风险等级显示
        function updateRiskLevel(slider) {
            const value = parseInt(slider.value);
            const riskElement = slider.parentElement.querySelector('.risk-level');

            let level, className;
            if (value < 30) {
                level = '低';
                className = 'risk-low';
            } else if (value < 60) {
                level = '中等';
                className = 'risk-medium';
            } else {
                level = '高';
                className = 'risk-high';
            }

            riskElement.textContent = level;
            riskElement.className = 'risk-level ' + className;
        }
    </script>
</body>
</html>
